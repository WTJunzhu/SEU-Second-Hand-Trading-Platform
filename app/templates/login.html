{% extends "base.html" %}

{% block title %}ç™»å½• - ä¸œå—å¤§å­¦æ ¡å›­äºŒæ‰‹äº¤æ˜“å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>ç™»å½•è´¦å·</h1>
        <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 0;">ç™»å½•åå³å¯æµè§ˆå’Œå‘å¸ƒå•†å“</p>
    </div>
</div>

<div class="container">
    <div class="card" style="max-width: 450px; margin: var(--spacing-2xl) auto;">
        <div class="card__body">
            <form id="login-form">
                <!-- ç”¨æˆ·åæˆ–é‚®ç®± -->
                <div class="form-group">
                    <label class="form-label" for="username">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        class="form-input" 
                        placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·åæˆ–é‚®ç®±"
                        required
                    >
                    <div class="form-error"></div>
                </div>

                <!-- å¯†ç  -->
                <div class="form-group">
                    <label class="form-label" for="password">å¯†ç </label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="form-input" 
                        placeholder="è¾“å…¥æ‚¨çš„å¯†ç "
                        required
                    >
                    <div class="form-error"></div>
                </div>

                <!-- è®°ä½æˆ‘ & å¿˜è®°å¯†ç  -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" id="remember" name="remember">
                        <span>è®°ä½æˆ‘</span>
                    </label>
                    <a href="#" class="btn btn--text" style="padding: 0;">å¿˜è®°å¯†ç ï¼Ÿ</a>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button type="submit" class="btn btn--primary btn--lg btn--block">
                    ç™»å½•
                </button>

                <!-- æ³¨å†Œé“¾æ¥ -->
                <div style="text-align: center; margin-top: var(--spacing-lg);">
                    <p style="margin: 0;">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="/register">ç«‹å³æ³¨å†Œ</a></p>
                </div>
            </form>

            <!-- å¸®åŠ©ä¿¡æ¯ -->
            <div class="alert alert--info" style="margin-top: var(--spacing-lg); margin-bottom: 0;">
                <span>ğŸ’¡</span>
                <div>
                    <strong>é¦–æ¬¡ä½¿ç”¨ï¼Ÿ</strong>
                    <p style="margin: var(--spacing-sm) 0 0 0; font-size: var(--font-size-sm);">
                        ä½¿ç”¨æ‚¨çš„ SEU é‚®ç®±è´¦å·æ³¨å†Œï¼Œå³å¯å¼€å§‹æµè§ˆå’Œäº¤æ˜“æ ¡å›­äºŒæ‰‹å•†å“ã€‚
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * ç™»å½•é¡µé¢é€»è¾‘
 */
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('login-form');
    const usernameField = document.getElementById('username');
    const passwordField = document.getElementById('password');

    /**
     * è¡¨å•æäº¤
     */
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // åŸºç¡€éªŒè¯
        if (!usernameField.value.trim()) {
            const errorEl = usernameField.parentElement.querySelector('.form-error');
            errorEl.textContent = 'ç”¨æˆ·åæˆ–é‚®ç®±ä¸èƒ½ä¸ºç©º';
            errorEl.classList.add('is-visible');
            return;
        }

        if (!passwordField.value) {
            const errorEl = passwordField.parentElement.querySelector('.form-error');
            errorEl.textContent = 'å¯†ç ä¸èƒ½ä¸ºç©º';
            errorEl.classList.add('is-visible');
            return;
        }

        // æ¸…é™¤é”™è¯¯æç¤º
        document.querySelectorAll('.form-error').forEach(el => el.classList.remove('is-visible'));

        // æäº¤ç™»å½•
        LoadingManager.show('æ­£åœ¨ç™»å½•...');
        
        try {
            const response = await API.user.login({
                username: usernameField.value,
                password: passwordField.value,
            });

            LoadingManager.hide();

            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            if (response.data?.user) {
                AuthManager.setUser(response.data.user);
                if (response.data.token) {
                    localStorage.setItem('token', response.data.token);
                }
            }

            NotificationManager.success('ç™»å½•æˆåŠŸ');
            
            // é‡å®šå‘åˆ°é¦–é¡µæˆ–æ¥æºé¡µé¢
            const redirect = new URLSearchParams(window.location.search).get('redirect');
            setTimeout(() => {
                window.location.href = redirect || '/';
            }, 1000);
        } catch (error) {
            LoadingManager.hide();
            
            if (error.statusCode === 401) {
                NotificationManager.error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            } else if (error.data?.message) {
                NotificationManager.error(error.data.message);
            } else {
                NotificationManager.error('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
    });

    /**
     * å®æ—¶æ¸…é™¤é”™è¯¯æç¤º
     */
    usernameField.addEventListener('input', () => {
        usernameField.parentElement.querySelector('.form-error').classList.remove('is-visible');
    });

    passwordField.addEventListener('input', () => {
        passwordField.parentElement.querySelector('.form-error').classList.remove('is-visible');
    });
});
</script>
{% endblock %}
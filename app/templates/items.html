{% extends "base.html" %}

{% block title %}æµè§ˆå•†å“ - ä¸œå—å¤§å­¦æ ¡å›­äºŒæ‰‹äº¤æ˜“å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 id="page-title">æµè§ˆå•†å“</h1>
        <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 0;" id="page-subtitle"></p>
    </div>
</div>

<div class="container">
    <div class="grid grid--cols-4">
        <!-- å·¦ä¾§ç­›é€‰æ  -->
        <div style="grid-column: 1 / 2;">
            <div class="card" style="position: sticky; top: 80px;">
                <div class="card__header">
                    <h3 style="margin: 0;">ç­›é€‰æ¡ä»¶</h3>
                </div>
                <div class="card__body" style="padding: var(--spacing-md);">
                    <!-- åˆ†ç±» -->
                    <div class="form-group">
                        <label class="form-label">åˆ†ç±»</label>
                        <select id="category-filter" class="form-select">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            <option value="books">æ•™æä¹¦ç±</option>
                            <option value="electronics">ç”µå­äº§å“</option>
                            <option value="daily">ç”Ÿæ´»ç”¨å“</option>
                            <option value="sports">è¿åŠ¨å™¨æ</option>
                        </select>
                    </div>

                    <!-- ä»·æ ¼èŒƒå›´ -->
                    <div class="form-group">
                        <label class="form-label">ä»·æ ¼èŒƒå›´</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                            <input type="number" id="min-price" class="form-input" placeholder="æœ€å°" min="0">
                            <input type="number" id="max-price" class="form-input" placeholder="æœ€å¤§" min="0">
                        </div>
                    </div>

                    <!-- æ’åº -->
                    <div class="form-group">
                        <label class="form-label">æ’åº</label>
                        <select id="sort-filter" class="form-select">
                            <option value="latest">æœ€æ–°ä¸Šæ¶</option>
                            <option value="popular">æœ€å—æ¬¢è¿</option>
                            <option value="price-asc">ä»·æ ¼ï¼šä½åˆ°é«˜</option>
                            <option value="price-desc">ä»·æ ¼ï¼šé«˜åˆ°ä½</option>
                        </select>
                    </div>

                    <!-- åº”ç”¨ç­›é€‰ -->
                    <button id="apply-filter" class="btn btn--primary btn--block">åº”ç”¨ç­›é€‰</button>
                    <button id="reset-filter" class="btn btn--secondary btn--block" style="margin-top: var(--spacing-sm);">é‡ç½®ç­›é€‰</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div style="grid-column: 2 / -1;">
            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-state__icon">ğŸ“­</div>
                <div class="empty-state__title">æ²¡æœ‰æ‰¾åˆ°å•†å“</div>
                <p class="empty-state__description">å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯</p>
            </div>

            <!-- å•†å“åˆ—è¡¨ -->
            <div class="grid grid--cols-3" id="items-container">
                <!-- éª¨æ¶å±åŠ è½½ -->
                <div class="skeleton" style="height: 300px;"></div>
                <div class="skeleton" style="height: 300px;"></div>
                <div class="skeleton" style="height: 300px;"></div>
                <div class="skeleton" style="height: 300px;"></div>
                <div class="skeleton" style="height: 300px;"></div>
                <div class="skeleton" style="height: 300px;"></div>
            </div>

            <!-- åˆ†é¡µ -->
            <div id="pagination" class="pagination"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * å•†å“åˆ—è¡¨é¡µé¢é€»è¾‘
 */
class ItemsPage {
    constructor() {
        this.currentPage = 1;
        this.pageSize = 12;
        this.filters = {
            query: new URLSearchParams(window.location.search).get('query') || '',
            category: new URLSearchParams(window.location.search).get('category') || '',
            minPrice: null,
            maxPrice: null,
            sort: 'latest',
        };
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.updatePageTitle();
        this.loadItems();
    }

    setupEventListeners() {
        document.getElementById('category-filter').addEventListener('change', (e) => {
            this.filters.category = e.target.value;
        });

        document.getElementById('min-price').addEventListener('change', (e) => {
            this.filters.minPrice = e.target.value ? parseInt(e.target.value) : null;
        });

        document.getElementById('max-price').addEventListener('change', (e) => {
            this.filters.maxPrice = e.target.value ? parseInt(e.target.value) : null;
        });

        document.getElementById('sort-filter').addEventListener('change', (e) => {
            this.filters.sort = e.target.value;
        });

        document.getElementById('apply-filter').addEventListener('click', () => {
            this.currentPage = 1;
            this.loadItems();
        });

        document.getElementById('reset-filter').addEventListener('click', () => {
            this.filters = {
                query: this.filters.query,
                category: '',
                minPrice: null,
                maxPrice: null,
                sort: 'latest',
            };
            document.getElementById('category-filter').value = '';
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            document.getElementById('sort-filter').value = 'latest';
            this.currentPage = 1;
            this.loadItems();
        });
    }

    updatePageTitle() {
        const titleEl = document.getElementById('page-title');
        const subtitleEl = document.getElementById('page-subtitle');

        if (this.filters.query) {
            titleEl.textContent = `"${this.filters.query}" çš„æœç´¢ç»“æœ`;
            subtitleEl.textContent = 'ä¸ºæ‚¨æŸ¥è¯¢çš„å•†å“åˆ—è¡¨';
        } else if (this.filters.category) {
            const categoryNames = {
                'books': 'æ•™æä¹¦ç±',
                'electronics': 'ç”µå­äº§å“',
                'daily': 'ç”Ÿæ´»ç”¨å“',
                'sports': 'è¿åŠ¨å™¨æ',
            };
            titleEl.textContent = categoryNames[this.filters.category] || 'æµè§ˆå•†å“';
            subtitleEl.textContent = 'è¯¥åˆ†ç±»çš„æ‰€æœ‰å•†å“';
        } else {
            titleEl.textContent = 'æµè§ˆå•†å“';
            subtitleEl.textContent = 'æ ¡å›­å†…çš„ç²¾å“äºŒæ‰‹å•†å“';
        }
    }

    async loadItems() {
        try {
            LoadingManager.show('åŠ è½½å•†å“ä¸­...');
            
            const params = {
                page: this.currentPage,
                limit: this.pageSize,
                query: this.filters.query,
                category: this.filters.category,
                minPrice: this.filters.minPrice,
                maxPrice: this.filters.maxPrice,
                sort: this.filters.sort,
            };

            const response = await API.item.search(params);
            LoadingManager.hide();

            this.renderItems(response.data?.items || []);
            this.renderPagination(response.data?.pagination || {});

            if (!response.data?.items || response.data.items.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('items-container').style.display = 'none';
            } else {
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('items-container').style.display = 'grid';
            }
        } catch (error) {
            LoadingManager.hide();
            NotificationManager.error('åŠ è½½å•†å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            console.error('åŠ è½½å•†å“å¤±è´¥:', error);
        }
    }

    renderItems(items) {
        const container = document.getElementById('items-container');
        
        if (items.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = items.map(item => `
            <a href="/items/${item.id}" class="product-card" style="text-decoration: none; color: inherit;">
                <img src="${item.image || '/static/images/placeholder.png'}" alt="${item.title}" class="product-card__image">
                <div class="product-card__content">
                    <h3 class="product-card__title">${item.title}</h3>
                    <p class="product-card__description">${item.description.substring(0, 60)}...</p>
                    <div class="product-card__price">Â¥${item.price.toFixed(2)}</div>
                    <div class="product-card__seller text-sm text-muted">å–å®¶: ${item.seller_name}</div>
                    ${item.stock > 0 ? '' : '<span class="product-card__badge">ç¼ºè´§</span>'}
                </div>
            </a>
        `).join('');
    }

    renderPagination(pagination) {
        const container = document.getElementById('pagination');
        const totalPages = pagination.total_pages || 1;

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        // ä¸Šä¸€é¡µ
        if (this.currentPage > 1) {
            html += `<a href="#" class="pagination__item" data-page="${this.currentPage - 1}">â† ä¸Šä¸€é¡µ</a>`;
        } else {
            html += `<span class="pagination__item is-disabled">â† ä¸Šä¸€é¡µ</span>`;
        }

        // é¡µç 
        for (let i = 1; i <= totalPages; i++) {
            if (i === this.currentPage) {
                html += `<span class="pagination__item is-active">${i}</span>`;
            } else {
                html += `<a href="#" class="pagination__item" data-page="${i}">${i}</a>`;
            }
        }

        // ä¸‹ä¸€é¡µ
        if (this.currentPage < totalPages) {
            html += `<a href="#" class="pagination__item" data-page="${this.currentPage + 1}">ä¸‹ä¸€é¡µ â†’</a>`;
        } else {
            html += `<span class="pagination__item is-disabled">ä¸‹ä¸€é¡µ â†’</span>`;
        }

        container.innerHTML = html;

        // åˆ†é¡µäº‹ä»¶
        container.querySelectorAll('a.pagination__item').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.currentPage = parseInt(link.dataset.page);
                this.loadItems();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    new ItemsPage();
});
</script>
{% endblock %}
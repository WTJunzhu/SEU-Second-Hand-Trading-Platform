{% extends "base.html" %}

{% block title %}购物车 - 东南大学校园二手交易平台{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>购物车</h1>
        <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 0;">查看和管理您的购物车</p>
    </div>
</div>

<div class="container">
    <div class="grid grid--cols-3">
        <!-- 主要内容 -->
        <div style="grid-column: 1 / 3;">
            <!-- 空购物车 -->
            <div id="empty-cart" class="empty-state" style="display: none;">
                <div class="empty-state__icon">🛒</div>
                <div class="empty-state__title">购物车为空</div>
                <p class="empty-state__description">还没有添加任何商品，快去浏览一些不错的物品吧！</p>
                <a href="/" class="btn btn--primary">继续购物</a>
            </div>

            <!-- 购物车列表 -->
            <div id="cart-items" style="display: none;">
                <div class="card">
                    <div class="card__body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">商品</th>
                                    <th style="width: 20%;">单价</th>
                                    <th style="width: 20%;">数量</th>
                                    <th style="width: 20%;">小计</th>
                                </tr>
                            </thead>
                            <tbody id="cart-tbody">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="card__footer">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <button id="continue-shopping" class="btn btn--secondary">继续购物</button>
                            <button id="clear-cart" class="btn btn--danger">清空购物车</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 侧边栏：订单摘要 -->
        <div style="grid-column: 3 / 4;">
            <div class="card" style="position: sticky; top: 80px;">
                <div class="card__header">
                    <h3 style="margin: 0;">订单摘要</h3>
                </div>
                <div class="card__body">
                    <!-- 商品数量 -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
                        <span>商品数量:</span>
                        <span class="font-bold" id="total-items">0</span>
                    </div>

                    <!-- 商品总数 -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
                        <span>商品种类:</span>
                        <span class="font-bold" id="total-kinds">0</span>
                    </div>

                    <!-- 分割线 -->
                    <div style="border-top: 1px solid var(--color-border); margin: var(--spacing-md) 0;"></div>

                    <!-- 小计 -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
                        <span>小计:</span>
                        <span class="font-bold">¥<span id="subtotal">0.00</span></span>
                    </div>

                    <!-- 提示信息 -->
                    <div class="alert alert--info" style="margin-bottom: var(--spacing-lg);">
                        <span>💡</span>
                        <div>
                            <strong>校园配送</strong>
                            <p style="margin: var(--spacing-xs) 0 0 0; font-size: var(--font-size-sm);">
                                商品将送至您选定的校园地点，配送完全免费。
                            </p>
                        </div>
                    </div>

                    <!-- 结账按钮 -->
                    <button id="checkout-btn" class="btn btn--primary btn--lg btn--block" style="margin-bottom: var(--spacing-md);">
                        前往结账
                    </button>

                    <!-- 登录提示 -->
                    <div id="login-prompt" class="alert alert--warning" style="display: none;">
                        请<a href="/login">登录</a>后进行结账
                    </div>
                </div>
            </div>

            <!-- 相关推荐 -->
            <div class="card" style="margin-top: var(--spacing-lg);">
                <div class="card__header">
                    <h3 style="margin: 0;">猜你喜欢</h3>
                </div>
                <div class="card__body">
                    <div id="recommendations" class="flex flex--col gap-md">
                        <!-- 动态填充 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * 购物车页面逻辑
 */
class CartPage {
    constructor() {
        this.cart = CartManager.getCart();
        this.init();
    }

    init() {
        this.render();
        this.setupEventListeners();
        window.addEventListener('cartUpdated', () => {
            this.cart = CartManager.getCart();
            this.render();
        });
    }

    render() {
        if (this.cart.length === 0) {
            document.getElementById('empty-cart').style.display = 'block';
            document.getElementById('cart-items').style.display = 'none';
        } else {
            document.getElementById('empty-cart').style.display = 'none';
            document.getElementById('cart-items').style.display = 'block';
            this.renderCartTable();
        }

        this.updateOrderSummary();
        this.loadRecommendations();
    }

    renderCartTable() {
        const tbody = document.getElementById('cart-tbody');
        
        tbody.innerHTML = this.cart.map(item => `
            <tr>
                <td>
                    <a href="/items/${item.itemId}" style="text-decoration: none; color: var(--color-primary); font-weight: 500;">
                        ${item.title}
                    </a>
                </td>
                <td>¥${item.price.toFixed(2)}</td>
                <td>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                        <button class="btn btn--secondary btn--sm" data-action="decrease" data-item-id="${item.itemId}" style="width: 30px; padding: 0;">−</button>
                        <input 
                            type="number" 
                            value="${item.quantity}" 
                            min="1" 
                            max="99" 
                            class="form-input" 
                            style="width: 50px; text-align: center; padding: var(--spacing-xs) var(--spacing-sm);"
                            data-item-id="${item.itemId}"
                            data-action="update"
                        >
                        <button class="btn btn--secondary btn--sm" data-action="increase" data-item-id="${item.itemId}" style="width: 30px; padding: 0;">+</button>
                    </div>
                </td>
                <td>¥${(item.price * item.quantity).toFixed(2)}</td>
            </tr>
            <tr>
                <td colspan="4" style="text-align: right; padding-top: 0;">
                    <button class="btn btn--danger btn--sm" data-action="remove" data-item-id="${item.itemId}">
                        删除
                    </button>
                </td>
            </tr>
        `).join('');

        // 绑定事件
        tbody.querySelectorAll('button, input').forEach(el => {
            if (el.dataset.action === 'decrease') {
                el.addEventListener('click', () => {
                    const itemId = el.dataset.itemId;
                    const item = this.cart.find(i => i.itemId === itemId);
                    CartManager.updateQuantity(itemId, item.quantity - 1);
                });
            } else if (el.dataset.action === 'increase') {
                el.addEventListener('click', () => {
                    const itemId = el.dataset.itemId;
                    const item = this.cart.find(i => i.itemId === itemId);
                    CartManager.updateQuantity(itemId, item.quantity + 1);
                });
            } else if (el.dataset.action === 'remove') {
                el.addEventListener('click', () => {
                    CartManager.removeItem(el.dataset.itemId);
                });
            } else if (el.dataset.action === 'update') {
                el.addEventListener('change', () => {
                    CartManager.updateQuantity(el.dataset.itemId, parseInt(el.value));
                });
            }
        });
    }

    updateOrderSummary() {
        const stats = CartManager.getStats();
        document.getElementById('total-items').textContent = stats.count;
        document.getElementById('total-kinds').textContent = stats.items;
        document.getElementById('subtotal').textContent = stats.total;

        // 登录检查
        if (!AuthManager.isLoggedIn()) {
            document.getElementById('login-prompt').style.display = 'block';
            document.getElementById('checkout-btn').disabled = true;
        } else {
            document.getElementById('login-prompt').style.display = 'none';
            document.getElementById('checkout-btn').disabled = false;
        }
    }

    setupEventListeners() {
        document.getElementById('continue-shopping').addEventListener('click', () => {
            window.location.href = '/';
        });

        document.getElementById('clear-cart').addEventListener('click', () => {
            if (confirm('确定要清空购物车吗？')) {
                CartManager.clear();
            }
        });

        document.getElementById('checkout-btn').addEventListener('click', () => {
            if (!AuthManager.isLoggedIn()) {
                window.location.href = `/login?redirect=/checkout`;
            } else {
                window.location.href = '/checkout';
            }
        });
    }

    async loadRecommendations() {
        try {
            const response = await API.recommend.getPersonalized({ limit: 3 });
            const container = document.getElementById('recommendations');

            if (response.data && response.data.length > 0) {
                container.innerHTML = response.data.map(item => `
                    <a href="/items/${item.id}" style="padding: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-lg); text-decoration: none; color: inherit; transition: all var(--duration-fast);" class="text-decoration-none">
                        <img src="${item.image || '/static/images/placeholder.png'}" alt="${item.title}" style="width: 100%; height: 100px; object-fit: cover; border-radius: var(--radius-md); margin-bottom: var(--spacing-sm);">
                        <div class="font-semibold text-sm">${item.title}</div>
                        <div class="text-primary font-bold">¥${item.price.toFixed(2)}</div>
                    </a>
                `).join('');
            }
        } catch (error) {
            console.error('加载推荐失败:', error);
        }
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    new CartPage();
});
</script>
{% endblock %}
    <div class="cart-summary">
        <p>总计: ¥<span id="total-price">0.00</span></p>
        <button id="checkout">结算</button>
    </div>
</div>
{% endblock %}
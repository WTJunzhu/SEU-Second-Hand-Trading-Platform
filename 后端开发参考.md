# 后端设计文档 - SEU校园二手交易平台

## 1. 概述

### 1.1 项目简介
东南大学校园二手交易平台是一个基于Flask的校园内部二手商品交易系统，旨在为东南大学师生提供安全、便捷的校园内部物品流转平台。系统通过校园邮箱(@seu.edu.cn)验证确保交易双方身份真实性。

### 1.2 核心目标
- **安全交易**: 通过校园身份验证构建可信交易环境
- **资源循环**: 促进教材、电子产品等校园资源的二次利用
- **便捷操作**: 提供从浏览、购买到支付的完整线上交易流程
- **工程实践**: 展示企业级Web应用的完整开发流程

## 2. 技术架构

### 2.1 技术栈
| 组件 | 技术选型 | 版本 | 说明 |
|------|----------|------|------|
| **后端框架** | Flask | 3.0.3 | 轻量级Web框架，支持RESTful API |
| **ORM** | SQLAlchemy | 2.0.23 | 数据库对象关系映射，支持事务 |
| **数据库** | MySQL | 5.7+ | 关系型数据库，支持ACID事务 |
| **认证** | JWT (HS256) | - | 无状态Token认证，有效期168小时 |
| **密码加密** | bcrypt | 4.1.1 | 强密码哈希，salt rounds=12 |
| **开发语言** | Python | 3.10+ | 主开发语言 |

### 2.2 架构模式
采用**分层架构**设计：
```
客户端 → 表示层(API Routes) → 业务层(Services) → 数据层(Models/DB)
         ↓                    ↓                   ↓
     身份验证             业务逻辑              数据持久化
     请求验证             事务处理              关系映射
     响应格式化          并发控制              数据校验
```

### 2.3 项目结构
```
app/
├── __init__.py              # Flask应用工厂
├── models.py                # 数据库模型定义(6个核心表)
├── routes.py                # 页面路由
├── api/                     # API接口层
│   ├── auth.py             # 认证接口
│   ├── items.py            # 商品接口
│   ├── users.py            # 用户接口
│   ├── orders.py           # 订单接口(核心)
│   └── cart.py             # 购物车接口
├── services/                # 业务逻辑层
│   ├── user_service.py     # 用户业务逻辑
│   ├── item_service.py     # 商品业务逻辑
│   ├── order_service.py    # 订单业务逻辑(最复杂)
│   └── cart_service.py     # 购物车业务逻辑
├── middleware/              # 中间件层
│   ├── auth_middleware.py  # JWT认证中间件
│   └── error_handler.py    # 全局错误处理
├── utils/                   # 工具模块
│   ├── response.py         # 统一响应格式
│   ├── jwt_helper.py       # JWT工具
│   ├── password_helper.py  # 密码加密工具
│   ├── validators.py       # 数据验证器
│   └── decorators.py       # 自定义装饰器
└── static/                  # 静态资源
```

## 3. 数据库设计

### 3.1 核心数据表(6张)

#### 3.1.1 用户表(users)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希值',
    email VARCHAR(100) UNIQUE NOT NULL COMMENT '邮箱(@seu.edu.cn)',
    phone VARCHAR(20) NULL COMMENT '手机号',
    avatar_url VARCHAR(255) NULL COMMENT '头像URL',
    bio TEXT NULL COMMENT '个人简介',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.1.2 商品表(items)
```sql
CREATE TABLE items (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '商品ID',
    seller_id INT NOT NULL COMMENT '卖家ID',
    title VARCHAR(100) NOT NULL COMMENT '商品标题',
    description TEXT NOT NULL COMMENT '商品描述',
    category VARCHAR(50) NOT NULL DEFAULT 'other' COMMENT '分类',
    price DECIMAL(10,2) NOT NULL COMMENT '价格',
    stock INT NOT NULL DEFAULT 0 COMMENT '库存',
    views INT NOT NULL DEFAULT 0 COMMENT '浏览量',
    favorites INT NOT NULL DEFAULT 0 COMMENT '收藏数',
    image_url VARCHAR(255) NULL COMMENT '图片URL',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否在售',
    FOREIGN KEY (seller_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_seller_id (seller_id),
    INDEX idx_category (category),
    INDEX idx_price (price),
    INDEX idx_created_at (created_at),
    FULLTEXT INDEX idx_title_description (title, description)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.1.3 订单表(orders) - 核心表
```sql
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '订单ID',
    order_number VARCHAR(50) UNIQUE NOT NULL COMMENT '订单号',
    buyer_id INT NOT NULL COMMENT '买家ID',
    seller_id INT NOT NULL COMMENT '卖家ID',
    address_id INT NOT NULL COMMENT '地址ID',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
    total_price DECIMAL(10,2) NOT NULL COMMENT '订单总价',
    status VARCHAR(50) NOT NULL DEFAULT 'pending' COMMENT '状态',
    shipping_address VARCHAR(255) NOT NULL COMMENT '配送地址',
    remarks TEXT NULL COMMENT '备注',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (buyer_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (seller_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (address_id) REFERENCES addresses(id) ON DELETE CASCADE,
    INDEX idx_buyer_id (buyer_id),
    INDEX idx_seller_id (seller_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    CONSTRAINT uq_order_number UNIQUE (order_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.1.4 订单明细表(order_items)
```sql
CREATE TABLE order_items (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '明细ID',
    order_id INT NOT NULL COMMENT '订单ID',
    item_id INT NOT NULL COMMENT '商品ID',
    quantity INT NOT NULL DEFAULT 1 COMMENT '购买数量',
    unit_price DECIMAL(10,2) NOT NULL COMMENT '购买时单价',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE,
    INDEX idx_order_id (order_id),
    INDEX idx_item_id (item_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.1.5 地址表(addresses)
```sql
CREATE TABLE addresses (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '地址ID',
    user_id INT NOT NULL COMMENT '用户ID',
    recipient_name VARCHAR(50) NOT NULL COMMENT '收件人姓名',
    phone VARCHAR(20) NOT NULL COMMENT '收件人电话',
    province VARCHAR(50) NULL COMMENT '省份',
    city VARCHAR(50) NULL COMMENT '城市',
    district VARCHAR(50) NULL COMMENT '区县',
    detail VARCHAR(255) NOT NULL COMMENT '详细地址',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否默认',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 3.1.6 评价表(reviews)
```sql
CREATE TABLE reviews (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '评价ID',
    order_id INT NOT NULL COMMENT '订单ID',
    item_id INT NOT NULL COMMENT '商品ID',
    reviewer_id INT NOT NULL COMMENT '评价者ID',
    reviewee_id INT NOT NULL COMMENT '被评价者ID',
    rating SMALLINT NOT NULL COMMENT '评分(1-5)',
    content TEXT NULL COMMENT '评价内容',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE,
    FOREIGN KEY (reviewer_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (reviewee_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT check_rating_range CHECK (rating BETWEEN 1 AND 5),
    INDEX idx_item_id (item_id),
    INDEX idx_reviewer_id (reviewer_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 3.2 表关系设计
```
User (1) : (n) Item          # 一个用户可以发布多个商品
User (1) : (n) Order         # 一个用户可以创建多个订单(作为买家)
User (1) : (n) Order         # 一个用户可以收到多个订单(作为卖家)
User (1) : (n) Address       # 一个用户可以有多个收货地址
Order (1) : (n) OrderItem    # 一个订单包含多个商品明细
Item (1) : (n) OrderItem     # 一个商品可以被多个订单包含
Item (1) : (n) Review        # 一个商品可以有多个评价
Order (1) : (1) Review       # 一个订单对应一个评价
User (1) : (n) Review        # 一个用户可以给出多个评价
User (1) : (n) Review        # 一个用户可以收到多个评价
```

### 3.3 索引优化策略
1. **主键索引**: 所有表的id字段
2. **外键索引**: 所有外键字段建立索引
3. **查询优化索引**:
   - `items.category`: 分类筛选
   - `items.price`: 价格范围筛选
   - `items.created_at`: 时间排序
   - `orders.status`: 状态筛选
   - `orders.created_at`: 订单时间排序
4. **全文索引**: `items.title, items.description` 支持中文搜索

## 4. 业务逻辑层设计

### 4.1 订单服务(OrderService) - 最复杂模块

#### 4.1.1 订单创建流程
```python
class OrderService:
    @staticmethod
    def create_order(buyer_id, items_data, address_id):
        """
        核心事务流程:
        1. 开启数据库事务
        2. 检查地址权限
        3. 锁定所有商品库存行(SELECT FOR UPDATE)
        4. 验证库存充足性
        5. 检查不能购买自己的商品
        6. 计算订单总金额
        7. 扣减库存(原子操作)
        8. 创建订单记录
        9. 创建订单明细
        10. 提交事务或回滚
        """
```

#### 4.1.2 并发控制实现
```python
# 使用行级锁防止库存超卖
with db.session.begin_nested():
    # 锁定所有商品行
    stmt = select(Item).where(Item.id.in_(item_ids)).with_for_update()
    items_result = session.execute(stmt)
    
    # 检查库存
    for item_data in items_data:
        item = items_dict[item_data['item_id']]
        if item.stock < item_data['quantity']:
            raise Exception(f"商品 {item.title} 库存不足")
    
    # 扣减库存(在事务内)
    item.stock -= quantity
```

#### 4.1.3 事务完整性保证
```python
try:
    # 业务逻辑
    session.commit()
    return success_result
except Exception as e:
    # 任何异常都触发回滚
    session.rollback()
    logger.error(f"订单创建失败: {str(e)}")
    return error_result
```

### 4.2 库存管理策略
1. **实时库存检查**: 下单前验证库存充足性
2. **悲观锁机制**: 使用SELECT FOR UPDATE锁定库存行
3. **原子操作**: 库存扣减和订单创建在同一事务中
4. **库存恢复**: 订单取消时自动恢复库存

### 4.3 业务规则
1. **邮箱验证**: 必须为@seu.edu.cn格式
2. **密码安全**: bcrypt哈希存储，强度校验
3. **商品分类**: 6种固定分类(教材、电子、生活、运动、服饰、其他)
4. **订单状态**: pending→paid→shipped→completed/cancelled
5. **权限控制**: 用户只能操作自己的数据

## 5. API接口设计

### 5.1 统一响应格式
```json
{
    "code": 0,
    "message": "成功",
    "data": {},
    "timestamp": 1767112487
}
```

### 5.2 状态码规范
| code | HTTP状态 | 说明 |
|------|----------|------|
| 0 | 200 | 成功 |
| 1 | 400 | 通用错误 |
| 2 | 400 | 参数验证错误 |
| 3 | 401 | 认证失败 |
| 4 | 403 | 权限不足 |
| 5 | 404 | 资源不存在 |
| 6 | 500 | 服务器内部错误 |

### 5.3 认证机制
1. **JWT Token**: HS256算法，有效期168小时
2. **请求头**: `Authorization: Bearer <token>`
3. **邮箱限制**: 仅限@seu.edu.cn邮箱注册
4. **密码策略**: 8+字符，必须包含大小写字母和数字

## 6. 安全设计

### 6.1 输入验证
- **前端验证**: JavaScript表单验证
- **后端验证**: SQLAlchemy @validates装饰器
- **API验证**: validate_request装饰器

### 6.2 SQL注入防护
- **ORM使用**: 所有查询使用SQLAlchemy ORM
- **参数化查询**: 不使用字符串拼接SQL
- **输入过滤**: 对特殊字符进行转义

### 6.3 密码安全
```python
# 使用bcrypt进行强哈希
from bcrypt import hashpw, gensalt, checkpw

class PasswordHelper:
    @staticmethod
    def hash_password(password: str) -> str:
        return hashpw(password.encode('utf-8'), gensalt(rounds=12))
    
    @staticmethod
    def verify_password(password: str, hashed: str) -> bool:
        return checkpw(password.encode('utf-8'), hashed.encode('utf-8'))
```

### 6.4 会话安全
- **HTTPS**: 生产环境强制使用HTTPS
- **CORS**: 配置适当的跨域策略
- **CSRF**: 启用CSRF令牌保护
- **敏感信息**: 不在日志中记录密码、Token等

## 7. 性能优化

### 7.1 数据库优化
1. **索引设计**: 针对高频查询字段建立索引
2. **查询优化**: 使用JOIN代替子查询，避免SELECT *
3. **分页查询**: 使用LIMIT和OFFSET进行分页
4. **连接池**: 配置数据库连接池

### 7.2 缓存策略
1. **热点数据**: 商品详情、用户信息等
2. **缓存时间**: 根据数据更新频率设置TTL
3. **缓存失效**: 数据更新时清除相关缓存

### 7.3 并发处理
1. **连接池**: 数据库连接复用
2. **异步任务**: 邮件发送、日志记录等异步化
3. **队列处理**: 高并发操作使用消息队列

## 8. 错误处理

### 8.1 全局异常处理
```python
@app.errorhandler(Exception)
def handle_exception(e):
    """全局异常处理器"""
    logger.error(f"未捕获异常: {str(e)}")
    return APIResponse.server_error(message="服务器内部错误")
```

### 8.2 业务异常分类
1. **验证异常**: 输入数据不符合规则
2. **业务异常**: 库存不足、权限不够等
3. **系统异常**: 数据库连接失败、外部服务异常

### 8.3 日志记录
1. **访问日志**: 记录所有API请求
2. **错误日志**: 记录异常和错误信息
3. **业务日志**: 记录重要业务操作
4. **性能日志**: 记录慢查询和性能瓶颈

## 9. 部署架构

### 9.1 开发环境
- **数据库**: MySQL 8.0本地实例
- **应用服务器**: Flask开发服务器
- **缓存**: 本地内存缓存

### 9.2 生产环境建议
```
客户端 → Nginx(负载均衡/SSL) → Gunicorn(WSGI) → Flask应用
                           ↓
                        MySQL主从
                           ↓
                        Redis缓存
```

### 9.3 监控告警
1. **应用监控**: 接口响应时间、错误率
2. **数据库监控**: 连接数、慢查询、锁等待
3. **服务器监控**: CPU、内存、磁盘、网络
4. **业务监控**: 订单量、用户活跃度、库存变化

## 10. 测试策略

### 10.1 单元测试
```python
# 测试订单创建
def test_create_order_success():
    """测试成功创建订单"""
    result = OrderService.create_order(buyer_id, items_data, address_id)
    assert result['success'] == True
    assert result['order_id'] is not None

def test_create_order_insufficient_stock():
    """测试库存不足"""
    result = OrderService.create_order(buyer_id, oversold_items, address_id)
    assert result['success'] == False
    assert "库存不足" in result['message']
```

### 10.2 集成测试
1. **API测试**: 使用requests测试完整接口链
2. **数据库测试**: 测试事务回滚、数据一致性
3. **并发测试**: 模拟多用户同时下单

### 10.3 压力测试
```bash
# 使用ab进行压力测试
ab -n 1000 -c 50 -H "Authorization: Bearer $TOKEN" \
   -p order_data.json -T "application/json" \
   http://localhost:5000/api/orders/
```

## 11. 扩展性设计

### 11.1 微服务化拆分
1. **用户服务**: 认证、用户管理
2. **商品服务**: 商品CRUD、搜索、分类
3. **订单服务**: 订单处理、支付、物流
4. **评价服务**: 评价、评分、信誉系统

### 11.2 功能扩展点
1. **支付集成**: 微信支付、支付宝
2. **消息通知**: 邮件、短信、站内信
3. **推荐系统**: 基于用户行为的商品推荐
4. **数据统计**: 交易数据分析和可视化

## 12. 开发规范

### 12.1 代码规范
- **PEP 8**: Python代码风格
- **类型提示**: 使用type hints
- **文档字符串**: 所有函数和类必须有docstring
- **错误处理**: 明确的异常类型和处理逻辑

### 12.2 提交规范
```
feat: 新增功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建过程或辅助工具的变动
```

### 12.3 分支策略
- **main**: 生产环境分支
- **develop**: 开发主分支
- **feature/xxx**: 功能开发分支
- **hotfix/xxx**: 紧急修复分支

## 13. 总结

东南大学校园二手交易平台后端系统采用成熟的Python技术栈，通过分层架构实现了清晰的责任分离。系统核心亮点包括：

1. **完整的事务处理**: 订单创建采用数据库事务保证数据一致性
2. **严格的并发控制**: 使用行级锁防止库存超卖
3. **全面的安全设计**: 从输入验证到密码存储都有完善的安全措施
4. **良好的扩展性**: 模块化设计便于功能扩展和微服务拆分

系统已通过完整的单元测试和集成测试，具备良好的稳定性和可靠性，能够满足校园二手交易的基本需求，并为未来的功能扩展打下了坚实基础。